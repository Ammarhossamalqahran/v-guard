import streamlit as st
import dns.resolver
import requests
import ssl
import socket
import datetime
import io
import re
import pandas as pd
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from urllib.parse import urlparse, quote

# --- CONFIGURATION ---
st.set_page_config(page_title="V-GUARD | Security Audit", page_icon="üõ°Ô∏è", layout="wide")
MY_WHATSAPP = "201102353779"
MY_EMAIL = "amarhossam0000@gmail.com"

# --- PDF GENERATION FUNCTION ---
def create_pdf(domain, results, server_info, score):
    buffer = io.BytesIO()
    c = canvas.Canvas(buffer, pagesize=letter)
    width, height = letter

    # Header
    c.setFont("Helvetica-Bold", 24)
    c.drawString(50, height - 50, "V-GUARD INTELLIGENCE")
    c.setFont("Helvetica", 14)
    c.drawString(50, height - 75, f"Security Score: {score}/100")
    
    # Color check for score in PDF (Visual text)
    if score < 50: grade = "POOR (CRITICAL RISK)"
    elif score < 80: grade = "MODERATE (NEEDS ATTENTION)"
    else: grade = "EXCELLENT (SECURE)"
    
    c.setFont("Helvetica-Bold", 12)
    c.drawString(50, height - 95, f"Grade: {grade}")
    c.line(50, height - 105, 550, height - 105)

    # General Info
    c.setFont("Helvetica", 12)
    c.drawString(50, height - 130, f"Target Domain: {domain}")
    c.drawString(50, height - 145, f"Scan Date: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M')}")
    c.drawString(50, height - 160, f"Server IP: {server_info.get('ip', 'N/A')}")
    c.drawString(50, height - 175, f"Location: {server_info.get('city', 'N/A')}, {server_info.get('country', 'N/A')}")
    
    # Section 1: DNS
    y = height - 210
    c.setFont("Helvetica-Bold", 16)
    c.drawString(50, y, "1. DNS & Email Security")
    c.setFont("Helvetica", 12)
    y -= 25
    c.drawString(70, y, f"SPF Record: {results['spf']}")
    y -= 20
    c.drawString(70, y, f"DMARC Policy: {results['dmarc']}")

    # Section 2: SSL
    y -= 50
    c.setFont("Helvetica-Bold", 16)
    c.drawString(50, y, "2. SSL/TLS Certificate")
    c.setFont("Helvetica", 12)
    y -= 25
    c.drawString(70, y, f"Status: {results['ssl_status']}")
    y -= 20
    c.drawString(70, y, f"Expires In: {results['ssl_days']} days")
    
    # Section 3: Headers
    y -= 50
    c.setFont("Helvetica-Bold", 16)
    c.drawString(50, y, "3. Security Headers")
    c.setFont("Helvetica", 12)
    y -= 25
    c.drawString(70, y, f"Clickjacking Protection: {results['clickjacking']}")
    y -= 20
    c.drawString(70, y, f"HSTS (HTTPS Force): {results['hsts']}")

    # Footer
    c.line(50, 100, 550, 100)
    c.setFont("Helvetica-Oblique", 10)
    c.drawString(50, 80, "Generated by V-Guard System | Contact: +201102353779")

    c.save()
    buffer.seek(0)
    return buffer

# --- SIDEBAR ---
with st.sidebar:
    st.title("V-GUARD üõ°Ô∏è")
    st.metric("System Version", "6.0 (Final)")
    st.write("---")
    st.markdown(f"[Chat on WhatsApp](https://wa.me/{MY_WHATSAPP})")

# --- MAIN APP ---
st.title("üõ°Ô∏è V-GUARD INTELLIGENCE SYSTEM")
st.markdown("#### Advanced Cyber Reconnaissance & Audit Tool")

# Tabs
tab1, tab2, tab3 = st.tabs(["üåê Full Site Audit", "üîë Password Lab", "üìû Client Support"])

# =========================================
# TAB 1: AUDIT + TRACKER + SCORE + PDF
# =========================================
with tab1:
    target_input = st.text_input("Enter Target URL/Email", placeholder="company.com")
    
    if st.button("INITIATE FULL SCAN üöÄ", type="primary"):
        if not target_input:
            st.warning("‚ö†Ô∏è Please enter a target.")
        else:
            # Domain Extraction
            domain = None
            if "@" in target_input and not target_input.startswith("http"):
                domain = target_input.split("@")[1]
            else:
                if not target_input.startswith(("http", "www")): target_input = "https://" + target_input
                try: domain = urlparse(target_input).netloc
                except: domain = None
            
            if domain:
                st.success(f"üéØ Target Locked: {domain}")
                
                # Variables to calculate score
                security_score = 0
                scan_data = {
                    "spf": "Not Found ‚ùå", "dmarc": "Not Found ‚ùå",
                    "ssl_status": "Not Secure ‚ùå", "ssl_days": "0",
                    "clickjacking": "Missing ‚ùå", "hsts": "Missing ‚ùå"
                }
                server_data = {"ip": "N/A", "city": "N/A", "country": "N/A"}

                # --- A. SERVER TRACKER ---
                try:
                    ip_address = socket.gethostbyname(domain)
                    server_data['ip'] = ip_address
                    try:
                        geo = requests.get(f"http://ip-api.com/json/{ip_address}").json()
                        if geo['status'] == 'success':
                            server_data['city'] = geo['city']
                            server_data['country'] = geo['country']
                            with st.expander("üåç Server Location Map (Click to Expand)", expanded=True):
                                c1, c2 = st.columns([1, 2])
                                with c1:
                                    st.write(f"**IP:** `{ip_address}`")
                                    st.write(f"**ISP:** {geo['isp']}")
                                    st.write(f"**Loc:** {geo['city']}, {geo['country']}")
                                with c2:
                                    map_df = pd.DataFrame({'lat': [geo['lat']], 'lon': [geo['lon']]})
                                    st.map(map_df, zoom=3)
                    except: pass
                except: st.error("‚ùå Could not resolve IP")
                
                st.markdown("---")

                # --- B. SECURITY SCANS ---
                
                # 1. DNS (50 Points)
                try:
                    ans = dns.resolver.resolve(domain, 'TXT')
                    for r in ans:
                        if "v=spf1" in r.to_text():
                            scan_data['spf'] = "Active ‚úÖ"
                            security_score += 25
                except: pass

                try:
                    dns.resolver.resolve(f"_dmarc.{domain}", 'TXT')
                    scan_data['dmarc'] = "Active ‚úÖ"
                    security_score += 25
                except: pass

                # 2. SSL (25 Points)
                try:
                    ctx = ssl.create_default_context()
                    with ctx.wrap_socket(socket.socket(), server_hostname=domain) as s:
                        s.settimeout(3.0)
                        s.connect((domain, 443))
                        cert = s.getpeercert()
                        edate = datetime.datetime.strptime(cert['notAfter'], '%b %d %H:%M:%S %Y %Z')
                        days = (edate - datetime.datetime.now()).days
                        scan_data['ssl_status'] = "Valid ‚úÖ"
                        scan_data['ssl_days'] = str(days)
                        if days > 0: security_score += 25
                except: pass

                # 3. Headers (25 Points)
                try:
                    r = requests.get(f"https://{domain}", timeout=5)
                    if 'X-Frame-Options' in r.headers:
                        scan_data['clickjacking'] = "Protected ‚úÖ"
                        security_score += 15
                    if 'Strict-Transport-Security' in r.headers:
                        scan_data['hsts'] = "Active ‚úÖ"
                        security_score += 10
                except: pass

                # --- C. SCORE DISPLAY ---
                col_score, col_details = st.columns([1, 2])
                
                with col_score:
                    st.metric("üõ°Ô∏è SECURITY SCORE", f"{security_score}/100")
                    if security_score < 50:
                        st.error("CRITICAL RISK")
                        st.progress(security_score)
                    elif security_score < 80:
                        st.warning("NEEDS IMPROVEMENT")
                        st.progress(security_score)
                    else:
                        st.success("EXCELLENT")
                        st.progress(security_score)

                with col_details:
                    st.write("### Analysis Breakdown:")
                    if scan_data['spf'] == "Active ‚úÖ": st.success("‚úÖ SPF Record Configured")
                    else: st.error("‚ùå SPF Record Missing (+25 pts)")
                    
                    if scan_data['dmarc'] == "Active ‚úÖ": st.success("‚úÖ DMARC Policy Active")
                    else: st.error("‚ùå DMARC Policy Missing (+25 pts)")

                    if scan_data['ssl_status'] == "Valid ‚úÖ": st.success("‚úÖ SSL Certificate Valid")
                    else: st.error("‚ùå SSL Missing or Expired (+25 pts)")
                
                st.markdown("---")

                # --- D. PDF REPORT ---
                pdf_bytes = create_pdf(domain, scan_data, server_data, security_score)
                st.download_button(
                    label="üìÑ DOWNLOAD OFFICIAL AUDIT REPORT (PDF)",
                    data=pdf_bytes,
                    file_name=f"VGuard_Report_{domain}.pdf",
                    mime="application/pdf",
                    use_container_width=True
                )

# =========================================
# TAB 2 & 3 (Same as previous)
# =========================================
with tab2:
    st.header("Password Strength Analysis")
    password = st.text_input("Enter Password", type="password")
    if st.button("ANALYZE STRENGTH üîê"):
        score = 0
        feedback = []
        if len(password) >= 8: score += 1
        else: feedback.append("‚ùå Too Short (Min 8 chars)")
        if re.search(r"[A-Z]", password): score += 1
        else: feedback.append("‚ö†Ô∏è Add Uppercase")
        if re.search(r"[0-9]", password): score += 1
        else: feedback.append("‚ö†Ô∏è Add Numbers")
        if re.search(r"[!@#$%^&*]", password): score += 1
        else: feedback.append("‚ö†Ô∏è Add Symbols")

        if score == 4:
            st.success("üõ°Ô∏è STATUS: UNBREAKABLE")
            st.progress(100)
        elif score >= 2:
            st.warning("‚ö†Ô∏è STATUS: MODERATE")
            st.progress(50)
        else:
            st.error("‚ùå STATUS: WEAK")
            st.progress(25)
        for tip in feedback: st.write(tip)

with tab3:
    st.header("üìû Contact V-Guard")
    c1, c2 = st.columns(2)
    with c1:
        st.link_button("Chat on WhatsApp üí¨", f"https://wa.me/{MY_WHATSAPP}")
    with c2:
        subject = quote("Security Audit Request")
        st.link_button("Send Email üìß", f"mailto:{MY_EMAIL}?subject={subject}")
