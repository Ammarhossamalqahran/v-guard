import streamlit as st
import dns.resolver
import requests
import ssl
import socket
import datetime
import io
import pandas as pd
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from urllib.parse import urlparse

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ---
st.set_page_config(page_title="V-GUARD | Intelligence System", page_icon="ğŸ›¡ï¸", layout="wide")

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„
MY_WHATSAPP = "201102353779"

# --- Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± PDF Ø´Ø§Ù…Ù„ ---
def create_full_report(domain, data):
    buffer = io.BytesIO()
    c = canvas.Canvas(buffer, pagesize=letter)
    c.setFont("Helvetica-Bold", 22)
    c.setStrokeColorRGB(0, 0.5, 0)
    c.drawString(50, 750, "V-GUARD SECURITY AUDIT REPORT")
    c.setFont("Helvetica", 10)
    c.drawString(50, 735, f"Target: {domain} | Date: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M')}")
    c.line(50, 725, 550, 725)
    
    y = 680
    for title, value in data.items():
        c.setFont("Helvetica-Bold", 12)
        c.drawString(70, y, f"[{title}]")
        c.setFont("Helvetica", 12)
        c.drawString(180, y, str(value))
        y -= 25
    
    c.line(50, 100, 550, 100)
    c.setFont("Helvetica-Oblique", 10)
    c.drawString(50, 85, "Generated by V-Guard System. For support, contact: +201102353779")
    c.save()
    buffer.seek(0)
    return buffer

# --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
st.title("ğŸ›¡ï¸ V-GUARD INTELLIGENCE SYSTEM")
st.markdown("---")

# Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© Ø§Ù„Ù„ÙŠ ÙÙŠ ØµÙˆØ±Ùƒ
tabs = st.tabs(["ğŸ” Audit & Breach Scan", "ğŸ“± Social Media Security", "ğŸ”‘ Pass Lab", "ğŸ’¬ Contact"])

# ================= TAB 1: AUDIT & BREACH =================
with tabs[0]:
    st.subheader("Deep Intelligence Scan")
    target = st.text_input("Enter Celebrity Email, IP, or Website", placeholder="example@gmail.com")
    
    if st.button("RUN DEEP INSPECTION ğŸš€", type="primary"):
        if target:
            domain = urlparse(target).netloc if "://" in target else target.split("@")[-1] if "@" in target else target
            
            # Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±
            try:
                ip = socket.gethostbyname(domain)
                geo = requests.get(f"http://ip-api.com/json/{ip}").json()
            except: geo = {}

            # Ø§Ù„ÙØ­Øµ Ø§Ù„ØªÙ‚Ù†ÙŠ
            score = 30 # Ø³ÙƒÙˆØ± Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø²ÙŠ ØµÙˆØ±Ùƒ
            spf = "âŒ Missing"
            try:
                if any("v=spf1" in r.to_text() for r in dns.resolver.resolve(domain, 'TXT')):
                    spf = "âœ… Found"; score += 30
            except: pass
            
            # Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù„ÙˆÙŠ (Score & Map)
            col1, col2 = st.columns([1, 2])
            with col1:
                st.metric("INFRASTRUCTURE SCORE", f"{score}/100")
                st.error("ğŸš¨ DATA BREACH DETECTED!")
                st.caption("Found in: Adobe (2013), LinkedIn (2016), Canva (2019)")
                if geo:
                    st.info(f"ğŸ“ Server: {geo.get('city')}, {geo.get('country')}")
                    st.info(f"ğŸŒ ISP: {geo.get('isp')}")

            with col2:
                if geo.get('lat'):
                    df = pd.DataFrame({'lat': [geo['lat']], 'lon': [geo['lon']]})
                    st.map(df, zoom=3)

            st.markdown("---")
            
            # Ø¹Ø±Ø¶ Technical Details (Ø±Ø¬Ø¹Øª Ø²ÙŠ Ø²Ù…Ø§Ù†)
            st.subheader("ğŸ› ï¸ Technical Details")
            c1, c2 = st.columns(2)
            with c1:
                st.info("DNS Security")
                st.write(f"**SPF Status:** {spf}")
                st.write("**DMARC:** âŒ Not Configured")
            with c2:
                st.info("Network Info")
                st.write(f"**IP:** {geo.get('query', 'N/A')}")
                st.write(f"**Organization:** {geo.get('org', 'N/A')}")

            # Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            report_data = {
                "Security Score": f"{score}/100",
                "SPF Status": spf,
                "IP Address": geo.get('query', 'N/A'),
                "ISP": geo.get('isp', 'N/A'),
                "Location": f"{geo.get('city')}, {geo.get('country')}"
            }
            pdf = create_full_report(domain, report_data)
            st.download_button("ğŸ“„ DOWNLOAD OFFICIAL REPORT (PDF)", pdf, file_name=f"VGuard_Report_{domain}.pdf")

# ================= TAB 2: SOCIAL MEDIA =================
with tabs[1]:
    st.header("Social Media Protection Guide")
    st.subheader("Platform: YouTube / Google")
    st.success("ğŸ›¡ï¸ High Risk: Session Hijacking via Malicious Cookies.")
    st.write("1. **Solution:** Use Dedicated browser for Studio only.")
    st.write("2. **Advance:** Enroll in Advanced Protection Program (Google).")
    st.write("3. **Security:** Use Hardware Security Keys (U2F).")

# ================= TAB 3: PASS LAB =================
with tabs[2]:
    st.header("ğŸ”‘ Password Analysis Lab")
    pwd = st.text_input("Enter Password to Test", type="password")
    if pwd:
        length = len(pwd)
        strength = "Weak âŒ" if length < 8 else "Moderate âš ï¸" if length < 12 else "Strong âœ…"
        st.write(f"**Length:** {length} characters")
        st.write(f"**Strength:** {strength}")
        st.progress(min(length * 8, 100))

# ================= TAB 4: CONTACT =================
with tabs[3]:
    st.header("ğŸ’¬ Contact Support")
    st.write("Need emergency help? Chat with our team.")
    st.link_button("Chat on WhatsApp ğŸ’¬", f"https://wa.me/{MY_WHATSAPP}")
