import streamlit as st
import dns.resolver
import requests
import socket
import datetime
import io
import re
import pandas as pd
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from urllib.parse import urlparse, quote

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
st.set_page_config(page_title="V-GUARD | Intelligence", page_icon="ğŸ›¡ï¸", layout="wide")

# Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø¹Ø¯Ù„Ù‡Ø§ Ù„Ùˆ Ù…Ø­ØªØ§Ø¬)
MY_WHATSAPP = "201102353779"
MY_EMAIL = "amarhossam0000@gmail.com"

# --- Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± PDF Ø§Ø­ØªØ±Ø§ÙÙŠ ---
def create_pro_report(domain, results):
    buffer = io.BytesIO()
    c = canvas.Canvas(buffer, pagesize=letter)
    c.setFont("Helvetica-Bold", 24)
    c.setStrokeColorRGB(0, 0.5, 0)
    c.drawString(50, 750, "V-GUARD DEEP INTEL REPORT")
    c.setFont("Helvetica", 10)
    c.drawString(50, 730, f"Target: {domain} | Report ID: VG-{datetime.datetime.now().strftime('%M%S')}")
    c.line(50, 720, 550, 720)
    y = 680
    for key, val in results.items():
        c.setFont("Helvetica-Bold", 12)
        c.drawString(70, y, f"[{key}]")
        c.setFont("Helvetica", 12)
        c.drawString(200, y, str(val))
        y -= 30
    c.line(50, 100, 550, 100)
    c.drawString(50, 80, "This report is confidential and generated by V-Guard Intelligence System.")
    c.save()
    buffer.seek(0)
    return buffer

# --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
st.title("ğŸ›¡ï¸ V-GUARD INTELLIGENCE SYSTEM")
st.markdown("---")

tabs = st.tabs(["ğŸ” Intelligence Hub", "ğŸ“± Social Media Security", "ğŸ”‘ Pass Lab", "ğŸ’¬ Contact"])

# ================= TAB 1: INTELLIGENCE HUB =================
with tabs[0]:
    st.subheader("Deep Infrastructure Reconnaissance")
    target = st.text_input("Enter Target Domain or Email", placeholder="example.com")
    
    if st.button("RUN DEEP INSPECTION ğŸš€", type="primary"):
        if target:
            domain = urlparse(target).netloc if "://" in target else target.split("@")[-1] if "@" in target else target
            try:
                ip = socket.gethostbyname(domain)
                geo = requests.get(f"http://ip-api.com/json/{ip}").json()
            except: geo = {}

            score = 20
            spf = "âŒ Missing"
            try:
                if any("v=spf1" in r.to_text() for r in dns.resolver.resolve(domain, 'TXT')):
                    spf = "âœ… Secured"; score += 40
            except: pass
            
            # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            col1, col2 = st.columns([1, 2])
            with col1:
                st.metric("SECURITY SCORE", f"{score}/100", delta="- Critical" if score < 60 else "Healthy")
                st.error("ğŸš¨ BREACH ALERT!")
                st.caption("Identity found in historical databases (Adobe, LinkedIn).")
                if geo:
                    st.info(f"ğŸ“ Location: {geo.get('city')}, {geo.get('country')}")
                    st.info(f"ğŸŒ ISP: {geo.get('isp')}")

            with col2:
                if geo.get('lat'):
                    df = pd.DataFrame({'lat': [geo['lat']], 'lon': [geo['lon']]})
                    st.map(df)

            st.markdown("---")
            st.subheader("ğŸ› ï¸ Technical Vulnerabilities")
            rep_data = {"IP Address": ip, "Location": f"{geo.get('city')}", "SPF Status": spf, "ISP": geo.get('isp')}
            st.json(rep_data)
            
            pdf = create_pro_report(domain, rep_data)
            st.download_button("ğŸ“„ DOWNLOAD FULL PDF REPORT", pdf, file_name=f"VGuard_{domain}.pdf")

# ================= TAB 2: SOCIAL MEDIA SECURITY =================
with tabs[1]:
    st.header("ğŸ“± Professional Protection Guide")
    st.write("Specialized security protocols for high-profile celebrities.")
    
    col_yt, col_ig = st.columns(2)
    with col_yt:
        st.markdown("### ğŸ¥ YouTube & Google")
        st.warning("Risk: Session Hijacking (Cookie Theft)")
        st.write("- Use **Advanced Protection Program**.")
        st.write("- Dedicated clean browser for Studio only.")
        st.write("- Hardware Keys (Yubikey) enforced.")
        
    with col_ig:
        st.markdown("### ğŸ“¸ Instagram & Meta")
        st.warning("Risk: Social Engineering / SIM Swapping")
        st.write("- Disable SMS 2FA; use **Authentication Apps**.")
        st.write("- Enforce 'Hidden Words' to prevent phishing links.")
        st.write("- Monitor 'Login Activity' weekly.")

# ================= TAB 3: PASS LAB (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°ÙƒÙŠØ©) =================
with tabs[2]:
    st.header("ğŸ”‘ Advanced Password Intelligence")
    pwd = st.text_input("Enter Password to Test Entropy", type="password")
    if pwd:
        has_upper = any(c.isupper() for c in pwd)
        has_num = any(c.isdigit() for c in pwd)
        has_sym = bool(re.search(r"[!@#$%^&*]", pwd))
        score = sum([has_upper, has_num, has_sym, len(pwd) >= 12]) * 25
        
        st.progress(score / 100)
        st.write(f"**Entropy Score:** {score}%")
        
        c1, c2, c3 = st.columns(3)
        c1.write("Uppercase: " + ("âœ…" if has_upper else "âŒ"))
        c2.write("Numbers: " + ("âœ…" if has_num else "âŒ"))
        c3.write("Symbols: " + ("âœ…" if has_sym else "âŒ"))

# ================= TAB 4: CONTACT =================
with tabs[3]:
    st.header("ğŸ’¬ Connect with V-Guard Team")
    st.write("24/7 Professional Emergency Response for VIPs.")
    
    col_wa, col_form = st.columns(2)
    with col_wa:
        st.subheader("Instant Support")
        st.link_button("Chat on WhatsApp ğŸ’¬", f"https://wa.me/{MY_WHATSAPP}", type="primary")
        st.write(f"Email: {MY_EMAIL}")
        
    with col_form:
        st.subheader("Inquiry Form")
        name = st.text_input("Your Name")
        msg = st.text_area("How can we help?")
        if st.button("Generate Email Link"):
            if name and msg:
                mail_link = f"mailto:{MY_EMAIL}?subject=V-Guard Inquiry&body=Name: {name}%0D%0A{msg}"
                st.markdown(f"[Click here to send Email ğŸ“§]({mail_link})")
